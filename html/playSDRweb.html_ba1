<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>
        <script src="pcmplayer.js"></script>
        <style>

body { 
  font-family: Helvetica, Arial, Geneva, sans-serif;
}

.header_mytitle
{
    font-size:30px;
    color: white;
    background-color:#808080;
    width: 1200px;
    text-align: center;
    font-weight: 900;
}

.header_subtitle
{
    font-size:20px;
    color: white;
    background-color:#808080;
    width: 1200px;
    text-align: center;
}

.status
{
    font: "Arial";
    font-size:18px;
    color: blue;
    width: 1200px;
    text-align: left;
}

.tuneinfo
{
    font: "Arial";
    font-size:26px;
    font-weight: 600;
    color: blue;
    width: 1200px;
    text-align: center;
}

.selectbox {
    width: 120px;
    padding:6px;
    margin: 0px;
    -webkit-border-radius:4px;
    -moz-border-radius:4px;
    border-radius:4px;
    background: #e8e8e8;
    color:#404040;
    outline:none;
    display: inline-block;
    -webkit-appearance:none;
    -moz-appearance:none;
    appearance:none;
    cursor:pointer;
    font-size: 16px;
    font-weight: 600;
}

canvas {
    display:block;
    margin: -2px;
}


</style>

        <script type="text/javascript">
        
            var coltab = [
                            [	0.0000	,	0.0000	,	0.0000	],
                            [	0.6000	,	0.9000	,	1.0000	],
                            [	0.0000	,	0.0000	,	1.0000	],
                            [	0.0157	,	0.0000	,	0.0000	],
                            [	0.0235	,	0.0000	,	0.0000	],
                            [	0.0314	,	0.0000	,	0.0000	],
                            [	0.0392	,	0.0000	,	0.0000	],
                            [	0.0471	,	0.0000	,	0.0000	],
                            [	0.0549	,	0.0000	,	0.0000	],
                            [	0.0627	,	0.0000	,	0.0000	],
                            [	0.0706	,	0.0000	,	0.0000	],
                            [	0.0784	,	0.0000	,	0.0000	],
                            [	0.0863	,	0.0000	,	0.0000	],
                            [	0.0941	,	0.0000	,	0.0000	],
                            [	0.1020	,	0.0000	,	0.0000	],
                            [	0.1098	,	0.0000	,	0.0000	],
                            [	0.1176	,	0.0000	,	0.0000	],
                            [	0.1255	,	0.0000	,	0.0000	],
                            [	0.1333	,	0.0000	,	0.0000	],
                            [	0.1412	,	0.0000	,	0.0000	],
                            [	0.1490	,	0.0000	,	0.0000	],
                            [	0.1569	,	0.0000	,	0.0000	],
                            [	0.1647	,	0.0000	,	0.0000	],
                            [	0.1725	,	0.0000	,	0.0000	],
                            [	0.1804	,	0.0000	,	0.0000	],
                            [	0.1882	,	0.0000	,	0.0000	],
                            [	0.1961	,	0.0000	,	0.0000	],
                            [	0.2039	,	0.0000	,	0.0000	],
                            [	0.2118	,	0.0000	,	0.0000	],
                            [	0.2196	,	0.0000	,	0.0000	],
                            [	0.2275	,	0.0000	,	0.0000	],
                            [	0.2353	,	0.0000	,	0.0000	],
                            [	0.2431	,	0.0000	,	0.0000	],
                            [	0.2510	,	0.0000	,	0.0000	],
                            [	0.2588	,	0.0000	,	0.0000	],
                            [	0.2667	,	0.0000	,	0.0000	],
                            [	0.2745	,	0.0000	,	0.0000	],
                            [	0.2824	,	0.0000	,	0.0000	],
                            [	0.2902	,	0.0000	,	0.0000	],
                            [	0.2980	,	0.0000	,	0.0000	],
                            [	0.3059	,	0.0000	,	0.0000	],
                            [	0.3137	,	0.0000	,	0.0000	],
                            [	0.3216	,	0.0000	,	0.0000	],
                            [	0.3294	,	0.0000	,	0.0000	],
                            [	0.3373	,	0.0000	,	0.0000	],
                            [	0.3451	,	0.0000	,	0.0000	],
                            [	0.3529	,	0.0000	,	0.0000	],
                            [	0.3608	,	0.0000	,	0.0000	],
                            [	0.3686	,	0.0000	,	0.0000	],
                            [	0.3765	,	0.0000	,	0.0000	],
                            [	0.3843	,	0.0000	,	0.0000	],
                            [	0.3922	,	0.0000	,	0.0000	],
                            [	0.4000	,	0.0000	,	0.0000	],
                            [	0.4078	,	0.0000	,	0.0000	],
                            [	0.4157	,	0.0000	,	0.0000	],
                            [	0.4235	,	0.0000	,	0.0000	],
                            [	0.4314	,	0.0000	,	0.0000	],
                            [	0.4392	,	0.0000	,	0.0000	],
                            [	0.4471	,	0.0000	,	0.0000	],
                            [	0.4549	,	0.0000	,	0.0000	],
                            [	0.4627	,	0.0000	,	0.0000	],
                            [	0.4706	,	0.0000	,	0.0000	],
                            [	0.4784	,	0.0000	,	0.0000	],
                            [	0.4863	,	0.0000	,	0.0000	],
                            [	0.4941	,	0.0000	,	0.0000	],
                            [	0.5020	,	0.0000	,	0.0000	],
                            [	0.5098	,	0.0098	,	0.0000	],
                            [	0.5176	,	0.0176	,	0.0000	],
                            [	0.5255	,	0.0255	,	0.0000	],
                            [	0.5333	,	0.0333	,	0.0000	],
                            [	0.5412	,	0.0412	,	0.0000	],
                            [	0.5490	,	0.0490	,	0.0000	],
                            [	0.5569	,	0.0569	,	0.0000	],
                            [	0.5647	,	0.0647	,	0.0000	],
                            [	0.5725	,	0.0725	,	0.0000	],
                            [	0.5804	,	0.0804	,	0.0000	],
                            [	0.5882	,	0.0882	,	0.0000	],
                            [	0.5961	,	0.0961	,	0.0000	],
                            [	0.6039	,	0.1039	,	0.0000	],
                            [	0.6118	,	0.1118	,	0.0000	],
                            [	0.6196	,	0.1196	,	0.0000	],
                            [	0.6275	,	0.1275	,	0.0000	],
                            [	0.6353	,	0.1353	,	0.0000	],
                            [	0.6431	,	0.1431	,	0.0000	],
                            [	0.6510	,	0.1510	,	0.0000	],
                            [	0.6588	,	0.1588	,	0.0000	],
                            [	0.6667	,	0.1667	,	0.0000	],
                            [	0.6745	,	0.1745	,	0.0000	],
                            [	0.6824	,	0.1824	,	0.0000	],
                            [	0.6902	,	0.1902	,	0.0000	],
                            [	0.6980	,	0.1980	,	0.0000	],
                            [	0.7059	,	0.2059	,	0.0000	],
                            [	0.7137	,	0.2137	,	0.0000	],
                            [	0.7216	,	0.2216	,	0.0000	],
                            [	0.7294	,	0.2294	,	0.0000	],
                            [	0.7373	,	0.2373	,	0.0000	],
                            [	0.7451	,	0.2451	,	0.0000	],
                            [	0.7529	,	0.2529	,	0.0000	],
                            [	0.7608	,	0.2608	,	0.0000	],
                            [	0.7686	,	0.2686	,	0.0000	],
                            [	0.7765	,	0.2765	,	0.0000	],
                            [	0.7843	,	0.2843	,	0.0000	],
                            [	0.7922	,	0.2922	,	0.0000	],
                            [	0.8000	,	0.3000	,	0.0000	],
                            [	0.8078	,	0.3078	,	0.0000	],
                            [	0.8157	,	0.3157	,	0.0000	],
                            [	0.8235	,	0.3235	,	0.0000	],
                            [	0.8314	,	0.3314	,	0.0000	],
                            [	0.8392	,	0.3392	,	0.0000	],
                            [	0.8471	,	0.3471	,	0.0000	],
                            [	0.8549	,	0.3549	,	0.0000	],
                            [	0.8627	,	0.3627	,	0.0000	],
                            [	0.8706	,	0.3706	,	0.0000	],
                            [	0.8784	,	0.3784	,	0.0000	],
                            [	0.8863	,	0.3863	,	0.0000	],
                            [	0.8941	,	0.3941	,	0.0000	],
                            [	0.9020	,	0.4020	,	0.0000	],
                            [	0.9098	,	0.4098	,	0.0000	],
                            [	0.9176	,	0.4176	,	0.0000	],
                            [	0.9255	,	0.4255	,	0.0000	],
                            [	0.9333	,	0.4333	,	0.0000	],
                            [	0.9412	,	0.4412	,	0.0000	],
                            [	0.9490	,	0.4490	,	0.0000	],
                            [	0.9569	,	0.4569	,	0.0000	],
                            [	0.9647	,	0.4647	,	0.0000	],
                            [	0.9725	,	0.4725	,	0.0000	],
                            [	0.9804	,	0.4804	,	0.0000	],
                            [	0.9882	,	0.4882	,	0.0000	],
                            [	0.9961	,	0.4961	,	0.0000	],
                            [	1.0000	,	0.5039	,	0.0000	],
                            [	1.0000	,	0.5118	,	0.0118	],
                            [	1.0000	,	0.5196	,	0.0196	],
                            [	1.0000	,	0.5275	,	0.0275	],
                            [	1.0000	,	0.5353	,	0.0353	],
                            [	1.0000	,	0.5431	,	0.0431	],
                            [	1.0000	,	0.5510	,	0.0510	],
                            [	1.0000	,	0.5588	,	0.0588	],
                            [	1.0000	,	0.5667	,	0.0667	],
                            [	1.0000	,	0.5745	,	0.0745	],
                            [	1.0000	,	0.5824	,	0.0824	],
                            [	1.0000	,	0.5902	,	0.0902	],
                            [	1.0000	,	0.5980	,	0.0980	],
                            [	1.0000	,	0.6059	,	0.1059	],
                            [	1.0000	,	0.6137	,	0.1137	],
                            [	1.0000	,	0.6216	,	0.1216	],
                            [	1.0000	,	0.6294	,	0.1294	],
                            [	1.0000	,	0.6373	,	0.1373	],
                            [	1.0000	,	0.6451	,	0.1451	],
                            [	1.0000	,	0.6529	,	0.1529	],
                            [	1.0000	,	0.6608	,	0.1608	],
                            [	1.0000	,	0.6686	,	0.1686	],
                            [	1.0000	,	0.6765	,	0.1765	],
                            [	1.0000	,	0.6843	,	0.1843	],
                            [	1.0000	,	0.6922	,	0.1922	],
                            [	1.0000	,	0.7000	,	0.2000	],
                            [	1.0000	,	0.7078	,	0.2078	],
                            [	1.0000	,	0.7157	,	0.2157	],
                            [	1.0000	,	0.7235	,	0.2235	],
                            [	1.0000	,	0.7314	,	0.2314	],
                            [	1.0000	,	0.7392	,	0.2392	],
                            [	1.0000	,	0.7471	,	0.2471	],
                            [	1.0000	,	0.7549	,	0.2549	],
                            [	1.0000	,	0.7627	,	0.2627	],
                            [	1.0000	,	0.7706	,	0.2706	],
                            [	1.0000	,	0.7784	,	0.2784	],
                            [	1.0000	,	0.7863	,	0.2863	],
                            [	1.0000	,	0.7941	,	0.2941	],
                            [	1.0000	,	0.8020	,	0.3020	],
                            [	1.0000	,	0.8098	,	0.3098	],
                            [	1.0000	,	0.8176	,	0.3176	],
                            [	1.0000	,	0.8255	,	0.3255	],
                            [	1.0000	,	0.8333	,	0.3333	],
                            [	1.0000	,	0.8412	,	0.3412	],
                            [	1.0000	,	0.8490	,	0.3490	],
                            [	1.0000	,	0.8569	,	0.3569	],
                            [	1.0000	,	0.8647	,	0.3647	],
                            [	1.0000	,	0.8725	,	0.3725	],
                            [	1.0000	,	0.8804	,	0.3804	],
                            [	1.0000	,	0.8882	,	0.3882	],
                            [	1.0000	,	0.8961	,	0.3961	],
                            [	1.0000	,	0.9039	,	0.4039	],
                            [	1.0000	,	0.9118	,	0.4118	],
                            [	1.0000	,	0.9196	,	0.4196	],
                            [	1.0000	,	0.9275	,	0.4275	],
                            [	1.0000	,	0.9353	,	0.4353	],
                            [	1.0000	,	0.9431	,	0.4431	],
                            [	1.0000	,	0.9510	,	0.4510	],
                            [	1.0000	,	0.9588	,	0.4588	],
                            [	1.0000	,	0.9667	,	0.4667	],
                            [	1.0000	,	0.9745	,	0.4745	],
                            [	1.0000	,	0.9824	,	0.4824	],
                            [	1.0000	,	0.9902	,	0.4902	],
                            [	1.0000	,	0.9980	,	0.4980	],
                            [	1.0000	,	1.0000	,	0.5059	],
                            [	1.0000	,	1.0000	,	0.5137	],
                            [	1.0000	,	1.0000	,	0.5216	],
                            [	1.0000	,	1.0000	,	0.5294	],
                            [	1.0000	,	1.0000	,	0.5373	],
                            [	1.0000	,	1.0000	,	0.5451	],
                            [	1.0000	,	1.0000	,	0.5529	],
                            [	1.0000	,	1.0000	,	0.5608	],
                            [	1.0000	,	1.0000	,	0.5686	],
                            [	1.0000	,	1.0000	,	0.5765	],
                            [	1.0000	,	1.0000	,	0.5843	],
                            [	1.0000	,	1.0000	,	0.5922	],
                            [	1.0000	,	1.0000	,	0.6000	],
                            [	1.0000	,	1.0000	,	0.6078	],
                            [	1.0000	,	1.0000	,	0.6157	],
                            [	1.0000	,	1.0000	,	0.6235	],
                            [	1.0000	,	1.0000	,	0.6314	],
                            [	1.0000	,	1.0000	,	0.6392	],
                            [	1.0000	,	1.0000	,	0.6471	],
                            [	1.0000	,	1.0000	,	0.6549	],
                            [	1.0000	,	1.0000	,	0.6627	],
                            [	1.0000	,	1.0000	,	0.6706	],
                            [	1.0000	,	1.0000	,	0.6784	],
                            [	1.0000	,	1.0000	,	0.6863	],
                            [	1.0000	,	1.0000	,	0.6941	],
                            [	1.0000	,	1.0000	,	0.7020	],
                            [	1.0000	,	1.0000	,	0.7098	],
                            [	1.0000	,	1.0000	,	0.7176	],
                            [	1.0000	,	1.0000	,	0.7255	],
                            [	1.0000	,	1.0000	,	0.7333	],
                            [	1.0000	,	1.0000	,	0.7412	],
                            [	1.0000	,	1.0000	,	0.7490	],
                            [	1.0000	,	1.0000	,	0.7569	],
                            [	1.0000	,	1.0000	,	0.7647	],
                            [	1.0000	,	1.0000	,	0.7725	],
                            [	1.0000	,	1.0000	,	0.7804	],
                            [	1.0000	,	1.0000	,	0.7882	],
                            [	1.0000	,	1.0000	,	0.7961	],
                            [	1.0000	,	1.0000	,	0.8039	],
                            [	1.0000	,	1.0000	,	0.8118	],
                            [	1.0000	,	1.0000	,	0.8196	],
                            [	1.0000	,	1.0000	,	0.8275	],
                            [	1.0000	,	1.0000	,	0.8353	],
                            [	1.0000	,	1.0000	,	0.8431	],
                            [	1.0000	,	1.0000	,	0.8510	],
                            [	1.0000	,	1.0000	,	0.8588	],
                            [	1.0000	,	1.0000	,	0.8667	],
                            [	1.0000	,	1.0000	,	0.8745	],
                            [	1.0000	,	1.0000	,	0.8824	],
                            [	1.0000	,	1.0000	,	0.8902	],
                            [	1.0000	,	1.0000	,	0.8980	],
                            [	1.0000	,	1.0000	,	0.9059	],
                            [	1.0000	,	1.0000	,	0.9137	],
                            [	1.0000	,	1.0000	,	0.9216	],
                            [	1.0000	,	1.0000	,	0.9294	],
                            [	1.0000	,	1.0000	,	0.9373	],
                            [	1.0000	,	1.0000	,	0.9451	],
                            [	1.0000	,	1.0000	,	0.9529	],
                            [	1.0000	,	1.0000	,	0.9608	],
                            [	1.0000	,	1.0000	,	0.9686	],
                            [	1.0000	,	1.0000	,	0.9765	],
                            [	 1.0	,	0.0	,	0.0	],
                            [	 1.0	,	0.0	,	0.0	]
            ];
            
            window.onload = onstart;
            
            var intv;
            var interval;
            var sockintv;
            var sockOpen = 0;
            var websocket;
            
            var start = 0;
            var end = 0;
            var tuneqrg = 0;
            var foffset = 0;
            var resolution = 1;
            var vertlines = 1;
            var vertmarker = 1;
            var ssbmode = 0;
            
            var start1 = 0;
            var end1 = 0;
            var tuneqrg1 = 0;
            var foffset1 = 0;
            var resolution1 = 1;
            
            var player;
            var playON = 0;
            
            function MouseWheelHandler(e)
            {
                // cross-browser wheel delta
                var e = window.event || e; // old IE support
                var delta = Math.max(-1, Math.min(1, (e.wheelDelta || -e.detail)));
                
                if(e.shiftKey == true)
                    delta *= 25;
                
                websocket.send("mousewh:"+ delta + "\0");

                return false;
            }
            
            function mousetune(e)
            {
                var xpos = e.clientX;
                var rect = document.getElementById("wf_overlay").getBoundingClientRect();
                websocket.send("mousepo:"+ (xpos - rect.left) + "\0");
            }
            
            function audioON()
            {
                player = new PCMPlayer({
                        encoding: '16bitInt',
                        channels: 1,
                        sampleRate: 8000,
                        flushingTime: 500
                });
                playON = 1;
            }

            function onstart()
            {
                setListboxes();
                
                // click into WF
                document.getElementById('wf_overlay').addEventListener
                ('click',
                    function(evt){
                        var xpos = evt.clientX;
                        var rect = document.getElementById("wf_overlay").getBoundingClientRect();
                        websocket.send("mousepo:"+ (xpos - rect.left) + "\0");
                    },false
                );
                
                // mouse wheel in WF
                var myitem = document.getElementById("wf_overlay");
                if (myitem.addEventListener)
                {
                    // IE9, Chrome, Safari, Opera
                    myitem.addEventListener("mousewheel", MouseWheelHandler, false);
                    // Firefox
                    myitem.addEventListener("DOMMouseScroll", MouseWheelHandler, false);
                }
                // IE 6/7/8
                else
                {
                    myitem.attachEvent("onmousewheel", MouseWheelHandler);
                }
                
                document.getElementById('wf_overlay').addEventListener('mousedown',function(e)
                {
                    document.getElementById('wf_overlay').addEventListener('mousemove',mousetune);
                }
                );
                
                document.getElementById('wf_overlay').addEventListener('mouseup',function(e)
                {
                    document.getElementById('wf_overlay').removeEventListener('mousemove',mousetune);
                }
                );

                sockintv = setInterval(checkSocket, 1000);
            }
            
            var reload = 0;
            
            function reloadData()
            {
                reload = 1;
            }
            
            function checkSocket()
            {
                if(sockOpen == 0)
                {
                    if(websocket != null)
                        websocket.close();
                    openWebSocket();
                }
                
                showLock();
            }

            var pix = new Array();
            var pixwidth;
            
            var pix1 = new Array();
            var pixwidth1;
            
            function drawWFtitle(id,fstart, fend, resolution)
            {
                var cnv = document.getElementById(id); 
                var ctx = cnv.getContext("2d");
                var width = cnv.width;
                var height = cnv.height;
                
                ctx.font = "16px Arial";
                ctx.fillStyle = "#0000c0";
                ctx.fillRect(0,0,width,height);
                
                ctx.fillStyle = "#ffffff";
                ctx.fillText(fstart/1e3,0,16);
                
                var txt = (((fend-fstart)/4+fstart)/1e3).toFixed(6);
                ctx.fillText(txt,width/4-10,16);
                
                ctx.textAlign = "center";
                txt = (((fend-fstart)/2+fstart)/1e3).toFixed(6);
                ctx.fillText(txt,width/2,16);
                
                txt = (((fend-fstart)*3/4+fstart)/1e3).toFixed(6);
                ctx.fillText(txt,width*3/4-7,16);

                ctx.textAlign = "right";
                txt = (fend/1e3).toFixed(6);
                ctx.fillText(txt,width,16);
            }
            
            function drawMODEtitle(id,fstart, fend, resolution)
            {
                var cnv = document.getElementById(id); 
                var ctx = cnv.getContext("2d");
                var width = cnv.width;
                var height = cnv.height;
                
                ctx.font = "16px Arial";
                // background
                ctx.fillStyle = "#0000c0";
                ctx.fillRect(0,0,width,height);
                
                // Beacons
                ctx.fillStyle = "#ff0000";
                var x1 = cpos(10489550);
                var x2 = cpos(10489555);
                ctx.fillRect(x1,0,x2-x1,20);
                
                var x1 = cpos(10489795);
                var x2 = cpos(10489800);
                ctx.fillRect(x1,0,x2-x1,20);
                
                ctx.font = "16px Arial";
                ctx.fillStyle = "#ffffff";
                ctx.fillText("B",cpos(10489551),15);
                ctx.fillText("B",cpos(10489796),15);
                
                // CW
                ctx.fillStyle = "#00afef";
                var x1 = cpos(10489555);
                var x2 = cpos(10489600);
                ctx.fillRect(x1,0,x2-x1,20);
                ctx.fillStyle = "#ffffff";
                ctx.fillText("CW only",cpos(10489566),15);
                
                // NB digital
                ctx.fillStyle = "#6f2f9f";
                var x1 = cpos(10489600);
                var x2 = cpos(10489620);
                ctx.fillRect(x1,0,x2-x1,20);
                ctx.fillStyle = "#ffffff";
                ctx.fillText("NB digi",cpos(10489602),15);
                
                // digital
                ctx.fillStyle = "#febf00";
                var x1 = cpos(10489620);
                var x2 = cpos(10489640);
                ctx.fillRect(x1,0,x2-x1,20);
                ctx.fillStyle = "#ffffff";
                ctx.fillText("digital",cpos(10489624),15);
                
                // mixed
                ctx.fillStyle = "#c55910";
                var x1 = cpos(10489640);
                var x2 = cpos(10489690);
                ctx.fillRect(x1,0,x2-x1,20);
                ctx.fillStyle = "#ffffff";
                ctx.fillText("MIXED modes",cpos(10489650),15);
                
                // SSB
                ctx.fillStyle = "#91cf4f";
                var x1 = cpos(10489690);
                var x2 = cpos(10489795);
                ctx.fillRect(x1,0,x2-x1,20);
                ctx.fillStyle = "#ffffff";
                ctx.fillText("SSB only",cpos(10489730),15);
            }
            
            function cpos(x)
            {
                var A = tuneqrg+start/1000;
                var B = tuneqrg+end/1000;
                
                var res = 1200 * (x-A)/(B-A);
                
                return Math.floor(res);
            }
            
            var wfcolor = "red";
            var linethickness = 1;
            var next_linethickness = 1;
            var sockurl = 'ws://wx.spdns.de:8090';
            //var sockurl = 'ws://192.168.0.2:8090';
            
            function draw_tune()
            {
                // Get the WF canvas and WF context
                var c = document.getElementById('tune');
                var ctx = c.getContext('2d');
                
                var x = foffset / resolution;
                
                ctx.fillStyle = '#ffffff';
                ctx.fillRect(0,0,c.width,c.height);
                
                ctx.fillStyle = '#00c000';
                ctx.fillRect(x,0,-10,c.height);
            }
            
            var specarrlen = 50;
            var midarr = new Array(specarrlen);
            var arrfirst = 1;
            
            function draw_spec()
            {
                if(arrfirst == 1)
                {
                    arrfirst = 0;
                    for(var i=0; i<specarrlen; i++)
                    {
                        midarr[i] = new Array(width);
                    }
                }
            
                var canvas = document.getElementById("spec"); 
                var context = canvas.getContext("2d");
            
                // Get the canvas dimensions
                var width = canvas.width;
                var height = canvas.height;
                
                context.fillStyle = '#ffffff';
                context.fillRect(0,0,width,height);
                
                context.strokeStyle = '#000000';
                context.fillStyle = '#8080ff';
                
                context.beginPath();
                
                context.moveTo(0, height-1);
                for(var x=0; x<width; x++)
                {
                    // shift midarr
                    for(var idx=(specarrlen-1); idx>=1; idx--)
                    {
                        midarr[idx][x] = midarr[idx-1][x];
                    }
                    // add new value
                    midarr[0][x] = pix[x] / 3;
                    // calc mid value
                    var mv = 0;
                    for(var idx=0; idx<specarrlen; idx++)
                    {
                        mv += midarr[idx][x];
                    }
                    mv /= specarrlen;
                    
                    context.lineTo(x,height - mv);
                }
                context.lineTo(x,height-1);

                context.fill();
                
                context.stroke();
            }
            
            function drawWF()
            {
                linethickness = next_linethickness;
                
                // Get the WF canvas and WF context
                var canvas = document.getElementById("wf"); 
                var context = canvas.getContext("2d");
            
                // Get the canvas dimensions
                var width = canvas.width;
                var height = canvas.height;
                
                // create a 1-line canvas for the new data
                var line_cnv = document.getElementById("makeline"); 
                var line_ctx = line_cnv.getContext("2d");
                var line_width = line_cnv.width;
                line_cnv.height = linethickness;
                var imagedata = line_ctx.createImageData(line_width, linethickness);
                // insert the new data into this line
                for( var y=0; y<linethickness; y++)
                {
                    var qrg = start;
                    for (var x = 0; x < line_width; x++) 
                    {
                        var off = y*(line_width*4) + x*4;
                        
                        if(wfcolor == "red")
                        {
                            imagedata.data[off] = 256*(coltab[pix[x]][0]);
                            imagedata.data[off+1] = 256*(coltab[pix[x]][1]);
                            imagedata.data[off+2] = 256*(coltab[pix[x]][2]);
                        }
                        if(wfcolor == "green")
                        {
                            imagedata.data[off] = 256*(coltab[pix[x]][1]);
                            imagedata.data[off+1] = 256*(coltab[pix[x]][0]);
                            imagedata.data[off+2] = 256*(coltab[pix[x]][2]);
                        }
                        if(wfcolor == "blue")
                        {
                            imagedata.data[off] = 256*(coltab[pix[x]][2]);
                            imagedata.data[off+1] = 256*(coltab[pix[x]][1]);
                            imagedata.data[off+2] = 256*(coltab[pix[x]][1]);
                        }
                        if(wfcolor == "white")
                        {
                            imagedata.data[off] = 256*(coltab[pix[x]][0]);
                            imagedata.data[off+1] = 256*(coltab[pix[x]][0]);
                            imagedata.data[off+2] = 256*(coltab[pix[x]][0]);
                        }
                        imagedata.data[off+3] = 255;
                        
                        qrg += resolution;
                    }
                }
                // and draw it into the 1-line canvas
                line_ctx.putImageData(imagedata, 0, 0);
                
                // now draw the 1-line canvas followed by the old WF canvas
                // this automatically shifts the old picture down one line
                context.drawImage(line_cnv, 0, 0);
                context.drawImage(canvas, 0, linethickness);
            }
            
            function drawOverlay()
            {
                var canvas = document.getElementById("wf_overlay"); 
                var context = canvas.getContext("2d");
            
                // Get the canvas dimensions
                var width = canvas.width;
                var height = canvas.height;
                
                context.clearRect(0,0,width,height);

                var ImageData = context.getImageData(0,0,width,height);

                if(vertmarker == 1)
                {
                
                    //$("#tuneinfo").html(start1 + " " + calcpos(start1) + " " + end1 + " " + calcpos(end1));
                    // draw transparent rectangle at the zoomed qrg range
                    for(var i=0; i<height; i++)
                    {
                        for(var j=calcpos(start1); j<calcpos(end1);j++)
                        {
                            ImageData.data[((i*(width*4)) + (j*4) + 0)] = 255;
                            ImageData.data[((i*(width*4)) + (j*4) + 1)] = 255;
                            ImageData.data[((i*(width*4)) + (j*4) + 2)] = 255;
                            ImageData.data[((i*(width*4)) + (j*4) + 3)] = 75;
                        }
                    }
                    
                    // make a vertical line in the middle (which is the carrier frequency)
                    j = calcpos(start1 + (end1-start1)/2);
                    for(var i=0; i<height; i++)
                    {
                        ImageData.data[((i*(width*4)) + (j*4) + 0)] = 255;
                        ImageData.data[((i*(width*4)) + (j*4) + 1)] = 255;
                        ImageData.data[((i*(width*4)) + (j*4) + 2)] = 255;
                        ImageData.data[((i*(width*4)) + (j*4) + 3)] = 255;
                    }
                }
                
                if(vertlines == 1)
                {
                    // draw es'hail-2 vertical lines
                    function vl(xpos,i)
                    {
                        var j = cpos(xpos);
                        ImageData.data[((i*(width*4)) + (j*4) + 0)] = 100;
                        ImageData.data[((i*(width*4)) + (j*4) + 1)] = 100;
                        ImageData.data[((i*(width*4)) + (j*4) + 2)] = 255;
                        ImageData.data[((i*(width*4)) + (j*4) + 3)] = 255;
                    }
                    
                    for(var i=0; i<height; i++)
                    {
                        vl(10489555,i);
                        vl(10489600,i);
                        vl(10489620,i);
                        vl(10489640,i);
                        vl(10489690,i);
                        vl(10489795,i);
                    }
                
                    // draw vertical lines every 50 kHz
                    for(var i=0; i<height; i+=8)
                    {
                        for(var j=0; j<width; j+=250)
                        {
                            if(j==0) continue;
                            
                            ImageData.data[((i*(width*4)) + (j*4) + 0)] = 255;
                            ImageData.data[((i*(width*4)) + (j*4) + 1)] = 255;
                            ImageData.data[((i*(width*4)) + (j*4) + 2)] = 255;
                            ImageData.data[((i*(width*4)) + (j*4) + 3)] = 255;
                        }
                    }
                }
                context.putImageData(ImageData,0,0);
            }
            
            function drawWF1()
            {
                linethickness = next_linethickness;
                
                // Get the WF canvas and WF context
                var canvas1 = document.getElementById("wf1"); 
                var context1 = canvas1.getContext("2d");
            
                // Get the canvas dimensions
                var width1 = canvas1.width;
                var height1 = canvas1.height;
                
                // create a 1-line canvas for the new data
                var line_cnv1 = document.getElementById("makeline1"); 
                var line_ctx1 = line_cnv1.getContext("2d");
                var line_width1 = line_cnv1.width;
                line_cnv1.height = linethickness;
                var imagedata1 = line_ctx1.createImageData(line_width1, linethickness);
                // insert the new data into this line
                for( var y=0; y<linethickness; y++)
                {
                    var qrg = start1;
                    for (var x = 0; x < line_width1; x++) 
                    {
                        var off = y*(line_width1*4) + x*4;
                        
                        if(wfcolor == "red")
                        {
                            imagedata1.data[off] = 256*(coltab[pix1[x]][0]);
                            imagedata1.data[off+1] = 256*(coltab[pix1[x]][1]);
                            imagedata1.data[off+2] = 256*(coltab[pix1[x]][2]);
                        }
                        if(wfcolor == "green")
                        {
                            imagedata1.data[off] = 256*(coltab[pix1[x]][1]);
                            imagedata1.data[off+1] = 256*(coltab[pix1[x]][0]);
                            imagedata1.data[off+2] = 256*(coltab[pix1[x]][2]);
                        }
                        if(wfcolor == "blue")
                        {
                            imagedata1.data[off] = 256*(coltab[pix1[x]][2]);
                            imagedata1.data[off+1] = 256*(coltab[pix1[x]][1]);
                            imagedata1.data[off+2] = 256*(coltab[pix1[x]][1]);
                        }
                        if(wfcolor == "white")
                        {
                            imagedata1.data[off] = 256*(coltab[pix1[x]][0]);
                            imagedata1.data[off+1] = 256*(coltab[pix1[x]][0]);
                            imagedata1.data[off+2] = 256*(coltab[pix1[x]][0]);
                        }
                        imagedata1.data[off+3] = 255;
                        
                        qrg += resolution1;
                    }
                }
                // and draw it into the 1-line canvas
                line_ctx1.putImageData(imagedata1, 0, 0);
                
                // now draw the 1-line canvas followed by the old WF canvas
                // this automatically shifts the old picture down one line
                context1.drawImage(line_cnv1, 0, 0);
                context1.drawImage(canvas1, 0, linethickness);
            }
            
            function calcpos(x)
            {
                var A = tuneqrg+start/1000;
                var B = tuneqrg+end/1000;
                var f = tuneqrg1+x/1000;
                
                var res = 1200 * (f-A)/(B-A);
                
                return Math.floor(res);
            }
            
            function drawConnect()
            {
                var canvas = document.getElementById("connect"); 
                var context = canvas.getContext("2d");
            
                // Get the canvas dimensions
                var width = canvas.width;
                var height = canvas.height;
                
                context.fillStyle = '#ffffff';
                context.fillRect(0,0,width,height);
                
                context.strokeStyle = '#000000';
                context.fillStyle = '#8080ff';
                
                context.beginPath();
                
                context.moveTo(0, height-1);
                context.lineTo(calcpos(start1), 1);
                context.lineTo(calcpos(end1), 1);
                context.lineTo(width-1, height-1);

                context.closePath();
                context.fill();
                
                context.stroke();
            }

            function get32(myarr)
            {
                var val = myarr[0];
                val <<= 8;
                val += myarr[1];
                val <<= 8;
                val += myarr[2];
                val <<= 8;
                val += myarr[3];
                return val;
            }
            
            var ftx = 8089500;
            var rflock = 0;
            
            function handle_type(type,arr,pos,len)
            {
                if(type == 0 && reload)
                {
                    var idx = pos+2;
                    rflock = arr[pos];
                    start = get32(arr.slice(idx));
                    end = get32(arr.slice(idx+4));
                    tuneqrg = get32(arr.slice(idx+8));
                    resolution = get32(arr.slice(idx+12));
                    foffset = get32(arr.slice(idx+16));
                    pix  = arr.slice(idx+20);
                    pixwidth = (end - start) / resolution;
                    
                    var fval = (tuneqrg + start/1000 + foffset/1000)/1e3;
                    var sd = "RX: " + fval.toFixed(6) + " MHz, TX: " + (fval-ftx/1000).toFixed(6) + " MHz";
                    $("#tuneinfo").html(sd);
                    
                    drawWFtitle("wf_title",tuneqrg+start/1000,tuneqrg+end/1000,resolution);
                    drawWFtitle("wf_txtitle",tuneqrg-ftx+start/1000,tuneqrg-ftx+end/1000,resolution);
                    drawMODEtitle("wf_modetitle",tuneqrg+start/1000,tuneqrg+end/1000,resolution);
                    drawWF();
                    draw_tune();
                    draw_spec();
                    reload = 0;
                }
                
                if(type == 1)
                {
                    var idx = pos + 2;
                    start1 = get32(arr.slice(idx));
                    end1 = get32(arr.slice(idx+4));
                    tuneqrg1 = get32(arr.slice(idx+8));
                    resolution1 = get32(arr.slice(idx+12));
                    foffset1 = get32(arr.slice(idx+16));
                    pix1  = arr.slice(idx+20);
                    pixwidth1 = (end - start) / resolution;
                    
                    drawWFtitle("wf_title1",tuneqrg1+start1/1000,tuneqrg1+end1/1000,resolution1);
                    drawWFtitle("wf_txtitle1",tuneqrg1-ftx+start1/1000,tuneqrg1-ftx+end1/1000,resolution1);
                    drawWF1();
                    drawConnect();
                    drawOverlay();
                }

                if(type == 2)
                {
                    if(playON == 1)
                    {
                        player.feed(arr.slice(pos,pos+len));
                    }
                }
            }
            
            function showLock()
            {
                lk = "sync ..............";
                if(rflock == 1) lk = " LOCKED to PSK beacon";
                $("#lockstat").html(lk);
            }

            function openWebSocket()
            {
                window.WebSocket = window.WebSocket || window.MozWebSocket;

                websocket = new WebSocket(sockurl);
                websocket.binaryType = "arraybuffer";

                websocket.onopen = function () {
                    sockOpen = 1;
                    $("#status").html("Connected to stream: " + window.location.hostname);
                    //alert("WebSocket is now OPEN");
                    websocket.send("ssbmode:"+ ssbmode + "\0");
                };

                websocket.onerror = function () {
                    $("#status").html("Error ... reconnecting ...");
                    websocket.close();
                    sockOpen = 0;
                };
                
                websocket.onclose = function () {
                    $("#status").html("Disconnected ... connecting ...");
                    websocket.close();
                    sockOpen = 0;
                };

                websocket.onmessage = function (message) 
                {
                    var arr = new Uint8Array(message.data);
                    // handle first element
                    var pos = 0;
                    var type = arr[pos++];
                    var len = (arr[pos++] << 8);
                    len += arr[pos++];
                    
                    handle_type(type,arr,pos,len);
                    pos += len;

                    if(arr.length > pos)
                    {
                        // handle second element
                        var type = arr[pos++];
                        var len = (arr[pos++] << 8);
                        len += arr[pos++];
                        handle_type(type,arr,pos,len);
                        pos += len;
                    }

                    if(arr.length > pos)
                    {
                        // handle 3rd element
                        var type = arr[pos++];
                        var len = (arr[pos++] << 8);
                        len += arr[pos++];
                        handle_type(type,arr,pos,len);
                    }
                    // remark: window.requestAnimationFrame(drawWF); do NOT use this, high CPU load and corrupts picture if in background*/
                };
                
                // store settings and send to server
                $('#color').click(function(e) {
                    e.preventDefault();
                    wfcolor = $(this).children("option:selected").val();
                    localStorage.setItem('color',wfcolor);
                });
                
                $('#speed').click(function(e) {
                    e.preventDefault();
                    clearInterval(intv);
                    interval = $(this).children("option:selected").val();
                    intv = setInterval(reloadData, interval);
                    localStorage.setItem('speed',interval);
                });
                
                $('#yzoom').click(function(e) {
                    e.preventDefault();
                    next_linethickness = Number($(this).children("option:selected").val());
                    localStorage.setItem('yzoom',next_linethickness);
                });

                $('#yline').click(function(e) {
                    e.preventDefault();
                    vertlines = Number($(this).children("option:selected").val());
                    localStorage.setItem('ylines',vertlines);
                });

                $('#ymarker').click(function(e) {
                    e.preventDefault();
                    vertmarker = Number($(this).children("option:selected").val());
                    localStorage.setItem('ymarker',vertmarker);
                });

                $('#ssbmode').click(function(e) {
                    e.preventDefault();
                    ssbmode = Number($(this).children("option:selected").val());
                    localStorage.setItem('ssbmode',ssbmode);
                    websocket.send("ssbmode:"+ ssbmode + "\0");
                });
            }
            
            function setListboxes()
            {
                var v = localStorage.getItem('color');
                if(v != null)
                {
                    wfcolor = v;
                    $('#color').val(wfcolor);
                }
                    
                v = localStorage.getItem('speed');
                if(v != null)
                {
                    interval = v;
                    clearInterval(intv);
                    intv = setInterval(reloadData, interval);
                    $('#speed').val(interval);
                }
                else
                {
                    intv = setInterval(reloadData, 10);
                }
                    
                v = localStorage.getItem('yzoom');
                if(v != null)
                {
                    next_linethickness = v;
                    $('#yzoom').val(next_linethickness);
                }
                    
                v = localStorage.getItem('ylines');
                if(v != null)
                {
                    vertlines = v;
                    $('#yline').val(vertlines);
                }
                    
                v = localStorage.getItem('ymarker');
                if(v != null)
                {
                    vertmarker = v;
                    $('#ymarker').val(vertmarker);
                }
                    
                v = localStorage.getItem('ssbmode');
                if(v != null)
                {
                    ssbmode = v;
                    $('#ssbmode').val(ssbmode);
                }
            }

        </script>
        </head>
    <body>
        <div class="header_mytitle" id="header_mytitle">es'hail-2 Live Stream</div>
        <div class="header_subtitle" id="header_subtitle">for SDRplay RSP1a by DJ0ABR</div>
        <br>
        <form>
            <select id="color" class="selectbox" name="color">
                <option value="red">red</option>
                <option value="green">green</option>
                <option value="blue">blue</option>
                <option value="white">white</option>
            </select>
            <select id="speed" class="selectbox" name="speed">
                <option value="10">full speed</option>
                <option value="100">100ms</option>
                <option value="200">200ms</option>
                <option value="300">300ms</option>
                <option value="500">500ms</option>
                <option value="750">750ms</option>
                <option value="1000">1s</option>
                <option value="2000">2s</option>
                <option value="4000">4s</option>
            </select>
            <select id="yzoom" class="selectbox" name="yzoom">
                <option value="1">1 pixel/line</option>
                <option value="2">2 pixel/line</option>
                <option value="3">3 pixel/line</option>
                <option value="4">4 pixel/line</option>
                <option value="5">5 pixel/line</option>
                <option value="6">6 pixel/line</option>
                <option value="7">7 pixel/line</option>
                <option value="8">8 pixel/line</option>
                <option value="9">9 pixel/line</option>
                <option value="10">10 pixel/line</option>
            </select>
            <select id="yline" class="selectbox" name="yline">
                <option value="1">QRG line ON</option>
                <option value="0">QRG line OFF</option>
            </select>
            <select id="ymarker" class="selectbox" name="ymarker">
                <option value="1">Marker ON</option>
                <option value="0">Marker OFF</option>
            </select>
            <select id="ssbmode" class="selectbox" name="ssbmode">
                <option value="0">LSB</option>
                <option value="1">USB</option>
            </select>
        </form>
        <br>
        <button onclick="audioON()">AUDIO ON</button>
        <a id="lockstat">Lockstatus</a>
        <br>
        <div id="status" class="status">Status</div>
        <div id="tuneinfo" class="tuneinfo">Tuner</div>
        <br>
        
        <div style="position: relative;">
            <canvas id="wf_title" width="1200" height="20" style="position: absolute; left: 0; top: 0px; z-index: 0;"></canvas>
            <canvas id="wf_txtitle" width="1200" height="20" style="position: absolute; left: 0; top: 20px; z-index: 0;"></canvas>
            <canvas id="wf_modetitle" width="1200" height="20" style="position: absolute; left: 0; top: 40px; z-index: 0;"></canvas>
            <canvas id="tune"       width="1200" height="5"   style="position: absolute; left: 0; top: 60px; z-index: 0;"></canvas>
            <canvas id="spec"       width="1200" height="150" style="position: absolute; left: 0; top: 65px; z-index: 0;"></canvas>
            <canvas id="wf_overlay" width="1200" height="300" style="position: absolute; left: 0; top: 215px; z-index: 1;"></canvas>
            <canvas id="wf"         width="1200" height="300" style="position: absolute; left: 0; top: 215px; z-index: 0;"></canvas>
            <canvas id="connect" width="1200" height="30" style="position: absolute; left: 0; top: 515px; z-index: 0;"></canvas>
            <canvas id="wf_title1" width="1200" height="20" style="position: absolute; left: 0; top: 545px; z-index: 0;"></canvas>
            <canvas id="wf_txtitle1" width="1200" height="20" style="position: absolute; left: 0; top: 565px; z-index: 0;"></canvas>
            <canvas id="wf1" width="1200" height="150" style="position: absolute; left: 0; top: 586px; z-index: 0;"></canvas>
            <canvas id="makeline" width="1200" height="10" style="display:none"></canvas>
            <canvas id="makeline1" width="1200" height="10" style="display:none"></canvas>
        </div>
    </body>
</html>

